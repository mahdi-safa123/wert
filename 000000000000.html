<!DOCTYPE html>
<!-- saved from url=(0060)file:///C:/Users/lenovo/Downloads/index_cut_price_final.html -->
<html lang="ar"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø· - Ù…ÙˆÙ‚Ø¹ Ø¬Ø¯ÙŠØ¯</title>
  <style>
body {
  font-family: Arial, sans-serif;
  direction: rtl;
  padding: 20px;
  background-color: #121212;
  color: #ffffff;
}
.card {
  background: #1e1e1e;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
  margin-bottom: 20px;
}
input, button {
  padding: 10px;
  margin: 5px 0;
  font-size: 16px;
  width: 300px;
  background-color: #2a2a2a;
  color: #ffffff;
  border: 1px solid #444;
}
button {
  margin-left: 10px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background-color: #2a2a2a;
  color: #ffffff;
}
th, td {
  border: 1px solid #444;
  padding: 10px;
  text-align: center;
}
th {
  background-color: #333;
  color: #fff;
}
#notification {
  background: #1e4620;
  border: 1px solid #4caf50;
  color: #b2fab4;
  font-weight: bold;
  padding: 10px;
  margin-bottom: 15px;
}
.review-button {
  background-color: #388e3c;
  color: white;
  border: none;
  padding: 10px 18px;
  font-size: 16px;
  cursor: pointer;
}
.review-button:disabled {
  background-color: #555;
  cursor: not-allowed;
}

#auditLogTable td {
  background-color: #1a1a1a;
  border: 1px solid #555;
  padding: 10px;
  border-radius: 6px;
  font-weight: bold;
}
#auditLogTable td[contenteditable="true"] {
  background-color: #262626;
}

</style>
</head>
<body>
  
<h1 style="text-align:center; font-size:32px; color:#222; margin-bottom:20px;">ğŸª™ Ø´Ø±Ø§Ø¡ Ù†Ù‚Ø§Ø· Ø³Ù†ØªØ§Øª</h1>

<div class="card" style="text-align:center; background:#222; border:1px solid #4caf50; max-width:400px; margin: 0 auto 20px;">
  <h2 style="color:#4caf50;">ğŸ’° Ø±ØµÙŠØ¯ Ø§Ù„Ù‚Ø§ØµØ©</h2>
  <input type="text" id="safeAmount" value="0" style="width: 300px; font-size: 28px; text-align:center; font-weight:bold;">
</div>

<h2>ğŸ§® Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø· (Ù…Ø¹Ø§Ø¯Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©)</h2>

  <div id="notification"></div>

  <div class="card">
    ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨: <input type="text" id="accountant"><br>

    ğŸ‘¥ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <input type="text" id="username"><br>
    ğŸ”¢ Ø±Ù…Ø² Ø§Ù„Ø¥Ø­Ø§Ù„Ø©: <input type="text" id="ref"><br>
    ğŸ’¬ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·: <input type="text" id="points"><br>
    <button onclick="calculateAndSave()">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø± ÙˆØ£Ø¶Ù Ù„Ù„Ø³Ø¬Ù„</button>
    <button id="reviewBtn" class="review-button" onclick="handleReview()">âœ”ï¸ ØªØ¯Ù‚ÙŠÙ‚</button>
    <div id="result" style="margin-top:10px;font-weight:bold;"></div>
  </div>

  <div class="card">
    <h3>ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„</h3>
    <table id="logTable">
      <thead>
        <tr>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
          <th>Ø±Ù…Ø² Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
          <th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ù…Ø±Ø§Ø¬Ø¹Ø©</th>
          <th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
<div style="text-align:center; margin-top:10px;">
  <button onclick="undoLastDeduction()">â†©ï¸ ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± Ø®ØµÙ…</button>
</div>

  </div>

  <div class="card">
    <h3>ğŸ“ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</h3>
    <table id="auditLogTable">
      <thead>
        <tr>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
          <th>Ø±Ù…Ø² Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
          <th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ù…Ø±Ø§Ø¬Ø¹Ø©</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <h4>ğŸ“Š Ù…Ø¬Ù…ÙˆØ¹ Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚: <span id="auditPointsSum">0</span></h4>
    <h4>ğŸ’° Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø³Ø¹Ø±: <span id="auditTotalPrice">0</span> Ø¯ÙŠÙ†Ø§Ø±</h4>
    <div style="text-align:center; margin-top:15px;">
      <button onclick="printAuditOnly()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ÙÙ‚Ø·</button>
    </div>
  </div>

    <div style="text-align:center; margin-top:15px;">
      <button onclick="saveAuditLog()">ğŸ’¾ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</button>
    </div>



  <div class="card">
    <h3>ğŸ“˜ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù‚Ø§ØµØ©</h3>
    ğŸ‘¤ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: <input type="text" id="safeSource" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø£Ø­Ù…Ø¯"><br>
    ğŸ’° Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¶Ø§ÙØ©: <input type="text" id="safeAddAmount" placeholder="Ù…Ø«Ù„Ø§Ù‹: 100000"><br>
    <button onclick="addSafeLog()">â• Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§ØµØ©</button>

    
<br><hr style="margin: 20px 0; border: 1px dashed #4caf50;">
<h3>â– Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© ØµØ§Ø¯Ø± Ù…Ù† Ø§Ù„Ù‚Ø§ØµØ©</h3>
ğŸ‘¤ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: <input type="text" id="safeOutSource" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø£Ø­Ù…Ø¯"><br>
ğŸ’¸ Ù…Ø¨Ù„Øº Ø§Ù„ØµØ§Ø¯Ø±: <input type="text" id="safeOutAmount" placeholder="Ù…Ø«Ù„Ø§Ù‹: 50000"><br>
ğŸ“ Ø§Ù„Ø³Ø¨Ø¨: <input type="text" id="safeOutReason" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªØ­ÙˆÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ"><br>
<button onclick="addSafeOutLog()">â– Ø¥Ø¶Ø§ÙØ© ØµØ§Ø¯Ø± Ù…Ù† Ø§Ù„Ù‚Ø§ØµØ©</button>

<table id="safeLogTable" style="margin-top:20px;">
      <thead>
        <tr>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
          <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
          <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
          <th>Ø§Ù„Ø³Ø¨Ø¨</th>
          <th>Ø­Ø°Ù</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
<div style="text-align:center; margin-top:10px;">
  <button onclick="undoLastDeduction()">â†©ï¸ ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± Ø®ØµÙ…</button>
</div>

  </div>


<script>
let reviewUsed = false;

function calculateAndSave() {
  const username = document.getElementById("username").value;
  const ref = document.getElementById("ref").value;
  const accountant = document.getElementById("accountant").value;
  const pointsInput = document.getElementById("points");
  const points = parseInt(pointsInput.value.replace(/[^\d]/g, "")) || 0;
  const resultElem = document.getElementById("result");
  const notifyElem = document.getElementById("notification");
  notifyElem.textContent = "";

  if (!points || points <= 0) {
    resultElem.innerText = "â— ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· ØµØ­ÙŠØ­.";
    return;
  }

  const rawPrice = (points / 5000) * 1320;
  const price = Math.floor(rawPrice / 1000) * 1000;
  const safeInput = document.getElementById("safeAmount");
  let safeAmount = parseInt(safeInput.value.replace(/[^\d]/g, "")) || 0;

  if (price > safeAmount) {
    resultElem.innerText = "â— Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙ ÙÙŠ Ø§Ù„Ù‚Ø§ØµØ©.";
    return;
  }

  
// Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø§Ù„Ù‚Ø§ØµØ©
  safeAmount -= price;
  safeInput.value = safeAmount.toLocaleString();

  resultElem.innerText = price.toLocaleString() + " Ø¯ÙŠÙ†Ø§Ø±";
  notifyElem.textContent = "âœ… ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­.";

  const table = document.querySelector("#logTable tbody");
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${new Date().toLocaleString("ar-EG")}</td>
    <td>${username}</td>
    <td>${ref}</td>
    <td>${points.toLocaleString()}</td>
    <td>${price.toLocaleString()}</td>
    <td>â€”</td>
  `;
  table.insertBefore(row, table.firstChild);
  reviewUsed = false;
  document.getElementById("reviewBtn").disabled = false;
  pointsInput.value = "";
}

function handleReview() {
  if (reviewUsed) return;
  markReviewed();
  document.getElementById("reviewBtn").disabled = true;
  reviewUsed = true;
}

function markReviewed() {
  const table = document.querySelector("#logTable tbody");
  const auditTable = document.querySelector("#auditLogTable tbody");
  const firstRow = table.rows[0];
  if (!firstRow) return;

  const cols = Array.from(firstRow.cells).map(td => td.textContent);
  const accountant = document.getElementById("accountant").value;

  const auditRow = document.createElement("tr");
  auditRow.innerHTML = `
    <td contenteditable="true">${new Date().toLocaleString("ar-EG")}</td>
    <td contenteditable="true">${cols[1]}</td>
    <td contenteditable="true">${cols[2]}</td>
    <td contenteditable="true">${cols[3]}</td>
    <td contenteditable="true">${cols[4]}</td>
    <td contenteditable="true">âœ“</td>
    <td contenteditable="true">${accountant}</td>
  `;
  auditTable.insertBefore(auditRow, auditTable.firstChild);
  updateAuditPointsSum();
}

function updateAuditPointsSum() {
  const rows = document.querySelectorAll("#auditLogTable tbody tr");
  let total = 0;
  rows.forEach(row => {
    const pts = row.cells[3]?.textContent?.replace(/[^\d]/g, "") || "0";
    total += parseInt(pts) || 0;
  });
  document.getElementById("auditPointsSum").textContent = total.toLocaleString();
  
    let totalPrice = 0;
    rows.forEach(row => {
        const price = row.cells[4]?.textContent?.replace(/[^\d]/g, "") || "0";
        totalPrice += parseInt(price) || 0;
    });
    document.getElementById("auditTotalPrice").textContent = totalPrice.toLocaleString();
    
}

function printAuditOnly() {
  const auditTable = document.getElementById("auditLogTable").outerHTML;
  const w = window.open("", "", "width=800,height=600");
  w.document.write("<html><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</title></head><body>");
  w.document.write("<h2>Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</h2>");
  w.document.write(auditTable);
  w.document.write("</body></html>");
  w.document.close();
  w.print();
}

document.getElementById("points").addEventListener("keydown", function(event) {
  if (event.key === "Enter") {
    event.preventDefault();
    calculateAndSave();
  }
});

document.addEventListener("keydown", function(e) {
  const active = document.activeElement;
  if (!active || !active.isContentEditable) return;

  const td = active;
  const tr = td.parentElement;
  const rowIndex = tr.rowIndex;
  const cellIndex = td.cellIndex;

  let target;
  if (e.key === "ArrowDown") {
    const nextRow = tr.nextElementSibling;
    if (nextRow) target = nextRow.cells[cellIndex];
  } else if (e.key === "ArrowUp") {
    const prevRow = tr.previousElementSibling;
    if (prevRow && prevRow.rowIndex > 0) target = prevRow.cells[cellIndex];
  } else if (e.key === "ArrowLeft") {
    if (cellIndex > 0) target = tr.cells[cellIndex - 1];
  } else if (e.key === "ArrowRight") {
    if (cellIndex < tr.cells.length - 1) target = tr.cells[cellIndex + 1];
  }

  if (target && target.isContentEditable) {
    e.preventDefault();
    target.focus();
  }
});


const topInputs = Array.from(document.querySelectorAll('#accountant, #username, #ref, #points'));

topInputs.forEach((input, idx) => {
  input.addEventListener('keydown', function (e) {
    if (e.key === 'ArrowDown' && idx < topInputs.length - 1) {
      e.preventDefault();
      topInputs[idx + 1].focus();
    } else if (e.key === 'ArrowUp' && idx > 0) {
      e.preventDefault();
      topInputs[idx - 1].focus();
    }
  });
});


// ØªÙ†Ø³ÙŠÙ‚ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚Ø§ØµØ© Ø¨Ø§Ù„ÙÙˆØ§ØµÙ„
document.addEventListener("DOMContentLoaded", function () {
  const safeInput = document.getElementById("safeAmount");
  safeInput.addEventListener("input", function () {
    let raw = this.value.replace(/[^\d]/g, "");
    this.value = parseInt(raw || "0").toLocaleString();
  });
});


function saveAuditLog() {
  const rows = document.querySelectorAll("#auditLogTable tbody tr");
  const data = [];

  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    data.push({
      Ø§Ù„ØªØ§Ø±ÙŠØ®: cells[0]?.textContent.trim(),
      Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: cells[1]?.textContent.trim(),
      Ø§Ù„Ø±Ù…Ø²: cells[2]?.textContent.trim(),
      Ø§Ù„Ù†Ù‚Ø§Ø·: cells[3]?.textContent.trim(),
      Ø§Ù„Ø³Ø¹Ø±: cells[4]?.textContent.trim(),
      Ù…Ø±Ø§Ø¬Ø¹Ø©: cells[5]?.textContent.trim(),
      Ø§Ù„Ù…Ø­Ø§Ø³Ø¨: cells[6]?.textContent.trim()
    });
  });

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Ø³Ø¬Ù„_Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚.json";
  a.click();
  URL.revokeObjectURL(url);
}


function addSafeLog() {
  const source = document.getElementById("safeSource").value.trim();
  const addAmountInput = document.getElementById("safeAddAmount");
  const amount = parseInt(addAmountInput.value.replace(/[^\d]/g, "")) || 0;
  if (!amount || amount <= 0 || !source) {
    alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ØµØ¯Ø± ØµØ­ÙŠØ­ ÙˆÙ…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.");
    return;
  }

  const safeInput = document.getElementById("safeAmount");
  let safeAmount = parseInt(safeInput.value.replace(/[^\d]/g, "")) || 0;
  safeAmount += amount;
  safeInput.value = safeAmount.toLocaleString();

  const table = document.querySelector("#safeLogTable tbody");
  const row = document.createElement("tr");
  row.innerHTML = `
    <td contenteditable="true">${new Date().toLocaleString("ar-EG")}</td>
    <td contenteditable="true">Ø¥Ø¶Ø§ÙØ©</td>
    <td contenteditable="true">${amount.toLocaleString()}</td>
    <td contenteditable="true">${source}</td>
  `;
  table.insertBefore(row, table.firstChild);

  addAmountInput.value = "";
  document.getElementById("safeSource").value = "";
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ø®ØµÙ… Ø§Ù„Ù‚Ø§ØµØ© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®ØµÙ… ÙƒÙ…ØµØ¯Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ
const originalCalculateAndSave = calculateAndSave;
calculateAndSave = function() {
  const username = document.getElementById("username").value;
  const ref = document.getElementById("ref").value;
  const accountant = document.getElementById("accountant").value;
  const pointsInput = document.getElementById("points");
  const points = parseInt(pointsInput.value.replace(/[^\d]/g, "")) || 0;
  const resultElem = document.getElementById("result");
  const notifyElem = document.getElementById("notification");
  notifyElem.textContent = "";

  if (!points || points <= 0) {
    resultElem.innerText = "â— ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· ØµØ­ÙŠØ­.";
    return;
  }

  const rawPrice = (points / 5000) * 1320;
  const price = Math.floor(rawPrice / 1000) * 1000;
  const safeInput = document.getElementById("safeAmount");
  let safeAmount = parseInt(safeInput.value.replace(/[^\d]/g, "")) || 0;

  if (price > safeAmount) {
    resultElem.innerText = "â— Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙ ÙÙŠ Ø§Ù„Ù‚Ø§ØµØ©.";
    return;
  }

  // Ø®ØµÙ… Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø§Ù„Ù‚Ø§ØµØ©
  safeAmount -= price;
  safeInput.value = safeAmount.toLocaleString();

  // Ø³Ø¬Ù„ Ø®ØµÙ… Ø§Ù„Ù‚Ø§ØµØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
  const table = document.querySelector("#safeLogTable tbody");
  const row = document.createElement("tr");
  row.innerHTML = `
    <td contenteditable="true">${new Date().toLocaleString("ar-EG")}</td>
    <td contenteditable="true">Ø®ØµÙ…</td>
    <td contenteditable="true">${price.toLocaleString()}</td>
    <td contenteditable="true">${accountant}</td>
  `;
  table.insertBefore(row, table.firstChild);

  resultElem.innerText = price.toLocaleString() + " Ø¯ÙŠÙ†Ø§Ø±";
  notifyElem.textContent = "âœ… ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­.";

  const logTable = document.querySelector("#logTable tbody");
  const logRow = document.createElement("tr");
  logRow.innerHTML = `
    <td>${new Date().toLocaleString("ar-EG")}</td>
    <td>${username}</td>
    <td>${ref}</td>
    <td>${points.toLocaleString()}</td>
    <td>${price.toLocaleString()}</td>
    <td>â€”</td>
  `;
  logTable.insertBefore(logRow, logTable.firstChild);
  reviewUsed = false;
  document.getElementById("reviewBtn").disabled = false;
  pointsInput.value = "";
};


document.addEventListener("keydown", function(e) {
  const active = document.activeElement;
  if (!active || !active.isContentEditable) return;

  const td = active;
  const tr = td.parentElement;
  const rowIndex = tr.rowIndex;
  const cellIndex = td.cellIndex;

  let target;
  if (e.key === "ArrowDown") {
    const nextRow = tr.nextElementSibling;
    if (nextRow) target = nextRow.cells[cellIndex];
  } else if (e.key === "ArrowUp") {
    const prevRow = tr.previousElementSibling;
    if (prevRow && prevRow.rowIndex > 0) target = prevRow.cells[cellIndex];
  } else if (e.key === "ArrowLeft") {
    if (cellIndex > 0) target = tr.cells[cellIndex - 1];
  } else if (e.key === "ArrowRight") {
    if (cellIndex < tr.cells.length - 1) target = tr.cells[cellIndex + 1];
  }

  if (target && target.isContentEditable) {
    e.preventDefault();
    target.focus();
  }
});


function addSafeOutLog() {
  const source = document.getElementById("safeOutSource").value.trim();
  const reason = document.getElementById("safeOutReason").value.trim();
  const outAmountInput = document.getElementById("safeOutAmount");
  const amount = parseInt(outAmountInput.value.replace(/[^\d]/g, "")) || 0;
  if (!amount || amount <= 0 || !source || !reason) {
    alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ ÙˆØ§Ù„Ø³Ø¨Ø¨ ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
    return;
  }

  const safeInput = document.getElementById("safeAmount");
  let safeAmount = parseInt(safeInput.value.replace(/[^\d]/g, "")) || 0;

  if (amount > safeAmount) {
    alert("â— Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙ ÙÙŠ Ø§Ù„Ù‚Ø§ØµØ© Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.");
    return;
  }

  safeAmount -= amount;
  safeInput.value = safeAmount.toLocaleString();

  const table = document.querySelector("#safeLogTable tbody");
  const row = document.createElement("tr");
  row.innerHTML = `
    <td contenteditable="true">${new Date().toLocaleString("ar-EG")}</td>
    <td contenteditable="true">ØµØ§Ø¯Ø±</td>
    <td contenteditable="true">${amount.toLocaleString()}</td>
    <td contenteditable="true">${source}</td>
    <td contenteditable="true">${reason}</td>
  `;
  table.insertBefore(row, table.firstChild);

  outAmountInput.value = "";
  document.getElementById("safeOutSource").value = "";
  document.getElementById("safeOutReason").value = "";
}


function undoLastDeduction() {
  const table = document.querySelector("#safeLogTable tbody");
  const rows = Array.from(table.rows);
  for (let row of rows) {
    const type = row.cells[1]?.textContent?.trim();
    if (type === "Ø®ØµÙ…" || type === "ØµØ§Ø¯Ø±") {
      const amount = parseInt(row.cells[2]?.textContent.replace(/[^\d]/g, "") || "0");
      let safeInput = document.getElementById("safeAmount");
      let safeAmount = parseInt(safeInput.value.replace(/[^\d]/g, "")) || 0;
      safeAmount += amount;
      safeInput.value = safeAmount.toLocaleString();
      row.remove();
      alert("âœ… ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± Ø®ØµÙ… ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§ØµØ©.");
      return;
    }
  }
  alert("â— Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®ØµÙ… ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.");
}


function deleteRow(button) {
  const row = button.closest("tr");
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±ØŸ")) {
    row.remove();
    updateAuditPointsSum?.(); // ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚
  }
}


function cleanInvalidRows() {
  const tables = ["logTable", "auditLogTable", "safeLogTable"];
  tables.forEach(id => {
    const table = document.getElementById(id);
    if (!table) return;
    const rows = Array.from(table.tBodies[0].rows);
    rows.forEach(row => {
      let invalid = false;
      const cells = Array.from(row.cells);
      for (let i = 0; i < cells.length - 1; i++) { // Ù†ØªØ¬Ø§Ù‡Ù„ Ø²Ø± Ø§Ù„Ø­Ø°Ù
        const text = cells[i].textContent.trim();
        if (text === "") {
          invalid = true;
          break;
        }
        // Ø¥Ø°Ø§ Ø§Ù„Ø®Ù„ÙŠØ© Ù„Ù„Ù†Ù‚Ø§Ø· Ø£Ùˆ Ø§Ù„Ø³Ø¹Ø±ØŒ ØªØ£ÙƒØ¯ Ø£Ù†Ù‡Ø§ Ø±Ù‚Ù…ÙŠØ©
        if (i === 3 || i === 4) {
          const num = parseInt(text.replace(/[^\d]/g, ""));
          if (isNaN(num)) {
            invalid = true;
            break;
          }
        }
      }
      if (invalid) row.remove();
    });
    updateAuditPointsSum?.();
  });
  alert("âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØµÙÙˆÙ ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø©.");
}

</script>


</body></html>